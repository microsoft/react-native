parameters:
  packager_platform: ''
  xcode_sdk: ''
  xcode_scheme: ''
  xcode_actions: ''
  xcode_destination: ''
  xcode_extraArgs: ''
  xcode_version: ''
  new_arch_enabled: ''
  use_hermes: ''

steps:
  - template: /.ado/templates/apple-tools-setup.yml@self
    parameters:
      slice_name: ${{ parameters.slice_name }}
      xcode_version: ${{ parameters.xcode_version }}

  - task: CmdLine@2
    displayName: yarn install
    inputs:
      script: yarn install --immutable

  - task: CmdLine@2
    displayName: pod install
    inputs:
      script: |
        cd packages/rn-tester
        bundle install
        bundle exec pod install
    env:
      RCT_NEW_ARCH_ENABLED: $(new_arch_enabled)
      USE_HERMES: $(use_hermes)

  - task: ShellScript@2
    displayName: 'Setup packager and WebSocket test server'
    inputs:
      scriptPath: '.ado/ado-test-setup.sh'
      disableAutoCwd: true
      cwd: ''

  - bash: |
      echo Preparing the packager for platform $PLATFORM
      curl --retry-connrefused --connect-timeout 5 --max-time 10 --retry 10 --retry-delay 5 --retry-max-time 120 "http://localhost:8081/packages/rn-tester/js/RNTesterApp.${PLATFORM}.bundle?platform=${PLATFORM}&dev=true" -o /dev/null
      curl --retry-connrefused --connect-timeout 5 --max-time 10 --retry 10 --retry-delay 5 --retry-max-time 120 "http://localhost:8081/packages/rn-tester/js/RNTesterApp.${PLATFORM}.bundle?platform=${PLATFORM}&dev=true&minify=false" -o /dev/null
      curl --retry-connrefused --connect-timeout 5 --max-time 10 --retry 10 --retry-delay 5 --retry-max-time 120 "http://localhost:8081/IntegrationTests/IntegrationTestsApp.bundle?platform=${PLATFORM}&dev=true" -o /dev/null
      curl --retry-connrefused --connect-timeout 5 --max-time 10 --retry 10 --retry-delay 5 --retry-max-time 120 "http://localhost:8081/IntegrationTests/RCTRootViewIntegrationTestApp.bundle?platform=${PLATFORM}&dev=true" -o /dev/null
    env:
      PLATFORM: ${{ parameters.packager_platform }}
    displayName: 'curl the packager'

  - template: /.ado/templates/apple-xcode-build.yml@self
    parameters:
      xcode_sdk: ${{ parameters.xcode_sdk }}
      xcode_workspacePath: packages/rn-tester/RNTesterPods.xcworkspace
      xcode_scheme: ${{ parameters.xcode_scheme }}
      xcode_actions: 'build'
      xcode_extraArgs: ${{ parameters.xcode_extraArgs }}

  - template: /.ado/templates/apple-xcode-build.yml@self
    parameters:
      xcode_sdk: ${{ parameters.xcode_sdk }}
      xcode_workspacePath: packages/rn-tester/RNTesterPods.xcworkspace
      xcode_scheme: ${{ parameters.xcode_scheme }}
      xcode_actions: 'test'
      xcode_extraArgs: ${{ parameters.xcode_extraArgs }}

  - task: ShellScript@2
    displayName: 'Cleanup packager and WebSocket test server'
    inputs:
      scriptPath: '.ado/ado-test-cleanup.sh'
      disableAutoCwd: true
      cwd: ''
    condition: always()
